import { useEffect, useMemo, useState } from 'react';
import type { PointEvent, Student } from '../types';
import type { MissionProgress, EnergyLog } from '../types.gamify';
import { db } from '../store/db';
import { buildPointsSnapshot } from '../utils/points';
import { evaluateGrowthProjection, type GrowthProjectionState } from '../utils/growthProjection';


import { StudentAvatar } from './StudentAvatar';


interface EnergyBoardProps {
  students: Student[];
  /**
   * Maximum number of entries displayed when the leaderboard is collapsed.
   * Set to a higher value if the layout can accommodate more rows by default.
   */
  maxCollapsedEntries?: number;
}

interface LeaderboardEntry {
  id: string;
  name: string;
  rank?: number;
  energy: number;
  weeklyEnergy: number;
  points: number;
  honorTitle?: string;
  projection: GrowthProjectionState;

  
  avatarUrl?: string;
  avatarPresetId?: string;

}

function groupByStudent<T extends { studentId: string }>(items: T[]) {
  const map = new Map<string, T[]>();
  items.forEach((item) => {
    const list = map.get(item.studentId) ?? [];
    list.push(item);
    map.set(item.studentId, list);
  });
  return map;
}

function pickLatestHonor(records: MissionProgress[]): string | undefined {
  let latest: { title: string; at: string } | undefined;
  records.forEach((record) => {
    if (!record.honorTitle || record.status !== 'completed') return;
    const timestamp = record.completedAt ?? record.date;
    if (!latest || timestamp > latest.at) {
      latest = { title: record.honorTitle, at: timestamp };
    }
  });
  return latest?.title;
}

function sumWeeklyEnergy(logs: EnergyLog[]): number {
  if (!logs.length) return 0;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - 7);
  const iso = cutoff.toISOString();
  return logs.reduce((sum, log) => {
    if (log.createdAt >= iso) {
      return sum + log.delta;
    }
    return sum;
  }, 0);
}

function formatHonorLabel(honor?: string) {
  return honor ? `鑽ｈ獕銆?{honor}銆峘 : '鑽ｈ獕寰呯偣浜?;
}

export function EnergyBoard({ students, maxCollapsedEntries = 5 }: EnergyBoardProps) {
  const [entries, setEntries] = useState<LeaderboardEntry[]>([]);
  const [loading, setLoading] = useState(false);
  const [expanded, setExpanded] = useState(false);

  useEffect(() => {
    let disposed = false;

    async function load() {
      if (!students.length) {
        setEntries([]);
        return;
      }

      setLoading(true);

      try {
        const studentIds = students.map((student) => student.id);

        const [pointEvents, missionProgress, energyLogs] = await Promise.all([
          db.pointEvents.where('studentId').anyOf(studentIds).toArray(),
          db.missionsProgress.where('studentId').anyOf(studentIds).toArray(),
          db.energyLogs.where('studentId').anyOf(studentIds).toArray(),
        ]);

        if (disposed) return;

        const pointMap = groupByStudent(pointEvents as PointEvent[]);
        const missionMap = groupByStudent(missionProgress as MissionProgress[]);
        const energyMap = groupByStudent(energyLogs as EnergyLog[]);

        const nextEntries = students.map((student) => {
          const energy = student.energy ?? 0;
          const studentPoints = pointMap.get(student.id) ?? [];
          const { total } = buildPointsSnapshot(studentPoints);
          const projection = evaluateGrowthProjection(total, energy);
          const weeklyEnergy = sumWeeklyEnergy(energyMap.get(student.id) ?? []);
          const honorTitle = pickLatestHonor(missionMap.get(student.id) ?? []);

          return {
            id: student.id,
            name: student.name,
            rank: student.currentRank,
            energy,
            weeklyEnergy,
            points: total,
            honorTitle,
            projection,

            
            avatarUrl: student.avatarUrl,
            avatarPresetId: student.avatarPresetId,

          };
        });

        if (!disposed) {
          setEntries(nextEntries);
        }
      } catch (error) {
        console.error('鍔犺浇鑳介噺姒滄暟鎹け璐?, error);
        if (!disposed) {
          setEntries([]);
        }
      } finally {
        if (!disposed) {
          setLoading(false);
        }
      }
    }

    void load();

    return () => {
      disposed = true;
    };
  }, [students]);

  const sortedEntries = useMemo(
    () =>
      [...entries].sort((a, b) => {
        if (b.energy !== a.energy) return b.energy - a.energy;
        if (b.points !== a.points) return b.points - a.points;
        return (b.weeklyEnergy ?? 0) - (a.weeklyEnergy ?? 0);
      }),
    [entries],
  );

  const visibleEntries = useMemo(() => {
    if (expanded) return sortedEntries;
    return sortedEntries.slice(0, maxCollapsedEntries);
  }, [expanded, sortedEntries, maxCollapsedEntries]);

  const honorCount = useMemo(() => entries.filter((entry) => Boolean(entry.honorTitle)).length, [entries]);
  const averageEnergy = useMemo(() => {
    if (!students.length) return 0;
    const total = students.reduce((sum, student) => sum + (student.energy ?? 0), 0);
    return Math.round(total / students.length);
  }, [students]);
  const averagePoints = useMemo(() => {
    if (!entries.length) return 0;
    const total = entries.reduce((sum, entry) => sum + entry.points, 0);
    return Math.round(total / entries.length);
  }, [entries]);
  const leadingSynergy = sortedEntries[0]?.projection.synergy;

  return (
    <div className="rounded-3xl border border-amber-100/80 bg-gradient-to-br from-amber-50 via-white to-emerald-50 p-6 shadow-lg backdrop-blur">
      <div className="flex flex-wrap items-start justify-between gap-4">
        <div>
          <p className="text-[11px] font-semibold uppercase tracking-[0.4em] text-amber-500">Coach View</p>
          <h2 className="mt-1 text-xl font-semibold text-slate-900">鐝骇鑳介噺鑽ｈ獕姒?/h2>
          <p className="mt-1 text-xs text-slate-500">
            鑱氱劍鑳介噺銆佺Н鍒嗕笌鑽ｈ獕涓夋潯绾匡紝璁╂瘡浣嶅媷澹兘鍦ㄦ涓婄湅鍒拌嚜宸辩殑鎴愰暱淇″彿銆?
          </p>
        </div>
        <div className="grid gap-2 text-right text-xs text-slate-500">
          <span className="inline-flex items-center justify-end gap-1 rounded-full bg-white/70 px-3 py-1 font-semibold text-amber-600 shadow">
            鈿?鐝潎鑳介噺 {averageEnergy}
          </span>
          <span className="inline-flex items-center justify-end gap-1 rounded-full bg-white/70 px-3 py-1 font-semibold text-emerald-600 shadow">
            馃尦 浜哄潎绉垎 {averagePoints}
          </span>
          <span className="inline-flex items-center justify-end gap-1 rounded-full bg-white/70 px-3 py-1 font-semibold text-violet-600 shadow">
            馃弲 鑽ｈ獕鐐逛寒 {honorCount}
          </span>
        </div>
      </div>

      {leadingSynergy ? (
        <div className="mt-4 rounded-2xl border border-emerald-100 bg-white/70 px-4 py-3 text-xs text-emerald-600">
          <span className="font-semibold">鐝骇鍏遍福 路 {leadingSynergy.title}</span>
          <span className="ml-2 text-emerald-500/70">{leadingSynergy.description}</span>
        </div>
      ) : null}

      <div className="mt-5 space-y-3">
        {loading && !sortedEntries.length ? (
          <div className="rounded-2xl border border-dashed border-slate-200 bg-white/70 px-4 py-6 text-center text-xs text-slate-400">
            姝ｅ湪鍚屾鍕囧＋鏁版嵁鈥?
          </div>
        ) : null}

        {!loading && !sortedEntries.length ? (
          <div className="rounded-2xl border border-dashed border-slate-200 bg-white/70 px-4 py-6 text-center text-xs text-slate-400">
            鏆傛棤鑳介噺璁板綍锛屾淳鍙戞寫鎴樻垨绛惧埌鍗冲彲鐐逛寒绗竴浣嶅媷澹€?
          </div>
        ) : null}

        {visibleEntries.map((entry, index) => (
          <div
            key={entry.id}
            className="relative overflow-hidden rounded-2xl border border-white/60 bg-white/90 px-5 py-4 shadow-sm"
          >
            <div className="flex flex-wrap items-start justify-between gap-4">
              <div className="flex items-start gap-3">
                <span
                  className={`flex h-10 w-10 items-center justify-center rounded-full text-sm font-semibold ${
                    index === 0
                      ? 'bg-gradient-to-br from-amber-400 to-orange-500 text-white'
                      : 'bg-slate-100 text-slate-600'
                  }`}
                >
                  #{index + 1}
                </span>

                
                <StudentAvatar
                  name={entry.name}
                  avatarUrl={entry.avatarUrl}
                  avatarPresetId={entry.avatarPresetId}
                  size="sm"
                  badge={entry.rank ? `L${entry.rank}` : undefined}
                />

                <div>
                  <p className="text-sm font-semibold text-slate-800">{entry.name}</p>
                  <p className="mt-1 text-xs text-slate-500">
                    娈典綅 L{entry.rank ?? '-'} 路 {formatHonorLabel(entry.honorTitle)}
                  </p>
                </div>
              </div>
              <div className="text-right">
                <p className="text-sm font-semibold text-amber-600">鈿?{entry.energy}</p>
                <p className="text-xs text-slate-500">杩?澶?+{entry.weeklyEnergy}</p>
              </div>
            </div>
            <div className="mt-3 flex flex-wrap gap-2 text-[11px] text-slate-500">
              <span className="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-1 text-emerald-600">
                {entry.projection.tree.current.icon} {entry.projection.tree.current.label}
              </span>
              <span className="inline-flex items-center gap-1 rounded-full bg-amber-50 px-2 py-1 text-amber-600">
                {entry.projection.hero.current.icon} {entry.projection.hero.current.label}
              </span>
              <span className="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1 text-slate-600">
                馃幆 鍕囧＋杩涢樁绉垎 {entry.points}
              </span>
              <span className="inline-flex items-center gap-1 rounded-full bg-sky-50 px-2 py-1 text-sky-600">
                馃敟 鍔ㄨ兘鍏辨尟 {entry.projection.synergy.title}
              </span>
            </div>
          </div>
        ))}
        {sortedEntries.length > maxCollapsedEntries ? (
          <button
            type="button"
            className="w-full rounded-2xl border border-dashed border-emerald-200 bg-white/80 py-3 text-xs font-semibold text-emerald-600 transition hover:border-emerald-300 hover:text-emerald-700"
            onClick={() => setExpanded((value) => !value)}
          >
            {expanded ? '鏀惰捣鍏ㄩ儴鍕囧＋' : `灞曞紑鍏ㄩ儴 ${sortedEntries.length} 浣嶅媷澹玚}
          </button>
        ) : null}
      </div>
    </div>
  );
}

